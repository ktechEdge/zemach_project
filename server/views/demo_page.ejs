<%- include ("./Gen_Edge_Design_Main/page_top.ejs") %>

<div class="plant-container">
    <% for (let row = 0; row < 12; row++) { %>
        <% for (let col = 0; col < 6; col++) { %>
            <div id="<%= row %>,<%= col %>" class="grid-item device-<%= Math.floor(row / 3) + 1 + col * 4 %>"></div>
        <% } %>
    <% } %>
</div>

<script>
    const letters = ['A', 'B', 'C', 'D', 'E', 'F'];

    document.querySelectorAll('.grid-item').forEach((item) => {
        const [row, col] = item.id.split(',').map(Number);
        const className = letters[col] + (row + 1);
        item.classList.add(className);
        item.textContent = className;
    });

    function fetchDeviceStatuses() {
        return fetch('/plants.json')
            .then(response => response.json())
            .then(data => data);
    }

    function updateGridColors() {
        fetchDeviceStatuses()
            .then(plants => {
                plants.forEach(plant => {
                    const gridItem = document.getElementById(plant.id);
                    if (gridItem) {
                        gridItem.classList.remove('connected', 'disconnected');
                        gridItem.classList.add(plant.connected ? 'connected' : 'disconnected');
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching plant data:', error);
            });
    }

    function getDeviceData() {
        const devices = {};

        document.querySelectorAll('.grid-item').forEach((item) => {
            const [row, col] = item.id.split(',').map(Number);
            const className = letters[col] + (row + 1);
            const deviceNumber = Math.floor(row / 3) + 1 + col * 4;

            if (!devices[deviceNumber]) {
                devices[deviceNumber] = [];
            }
            devices[deviceNumber].push(className);
        });

        return Object.entries(devices).map(([device, plants]) => ({ device: Number(device), plants }));
    }


    function sendDeviceData() {
        const deviceData = getDeviceData();

        fetch('/save_device_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deviceData),
        })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }


    updateGridColors();
    sendDeviceData();
</script>

<style>
    .connected {
        background-color: green;
    }

    .disconnected {
        background-color: red;
    }
</style>

<%- include ("./Gen_Edge_Design_Main/page_bottom.ejs") %>
